<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DM Control Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root { --primary: #6200ea; --secondary: #00bfa5; --dark: #1a1a1a; --light: #f5f5f5; --danger: #d32f2f; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #121212; color: #e0e0e0; display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER */
        header { background: #1f1f1f; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); }
        h1 { margin: 0; font-size: 1.2rem; color: var(--secondary); }
        .status-bar { font-size: 0.9rem; display: flex; align-items: center; gap: 10px; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; background: gray; display: inline-block; }

        /* LAYOUT */
        .main-container { display: grid; grid-template-columns: 300px 1fr 350px; gap: 10px; padding: 10px; height: calc(100vh - 60px); overflow: hidden; }
        .panel {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            /* CAMBIO CLAVE: De 'hidden' a 'auto' para que aparezca barra de scroll si no cabe */
            overflow-y: auto; 
            border: 1px solid #333;
            max-height: 100%; /* Asegura que no se salga de su cuadr√≠cula */
        }       
        .audio-section {
            background: #2a2a2a;
            border: 1px solid #444;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
       #whiteboard-wrapper {
            flex-shrink: 0; /* Evita que la pizarra se coma a los otros elementos */
            min-height: 400px;
            margin-top: 15px;
        }
        .panel h2 { margin-top: 0; font-size: 1rem; border-bottom: 1px solid #444; padding-bottom: 5px; color: #bbb; }

        /* INICIATIVA */
        .initiative-list { flex: 1; overflow-y: auto; margin-top: 10px; }
        .initiative-item { background: #2c2c2c; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid transparent; }
        .initiative-item.active-turn { border-left-color: var(--secondary); background: #333; }
        .initiative-item.defeated { opacity: 0.5; text-decoration: line-through; }
        .hp-input { background: #111; border: 1px solid #444; color: white; padding: 2px; width: 40px; text-align: center; }
        .controls-row { display: flex; gap: 5px; margin-top: 10px; }
        button { cursor: pointer; background: #444; color: white; border: none; padding: 5px 10px; border-radius: 4px; transition: 0.2s; }
        button:hover { background: #555; }
        button.primary { background: var(--primary); }
        button.danger { background: var(--danger); }

        /* --- PIZARRA Y VISOR (NUEVO ESTILO) --- */
        .center-tabs { display: flex; margin-bottom: 5px; background: #111; border-radius: 4px; padding: 2px; }
        .center-tab-btn { flex: 1; border: none; background: transparent; color: #888; padding: 5px; cursor: pointer; }
        .center-tab-btn.active { background: #333; color: white; font-weight: bold; border-radius: 4px; }

        #whiteboard-wrapper, #markdown-viewer-wrapper { flex: 1; border: 1px solid #444; background: white; border-radius: 4px; display: none; flex-direction: column; }
        /* Mostrar por defecto uno */
        #whiteboard-wrapper.visible, #markdown-viewer-wrapper.visible { display: flex; }
        
        .wb-toolbar { background: #eee; padding: 5px; display: flex; gap: 5px; border-bottom: 1px solid #ccc; flex-wrap: wrap; }
        .wb-toolbar button { color: #333; background: white; border: 1px solid #ccc; padding: 4px 8px; }
        .wb-toolbar button.active { background: var(--secondary); color: white; border-color: var(--secondary); }
        #canvasContainer { flex: 1; overflow: hidden; position: relative; background-color: white; }
        
        .wb-fullscreen { position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; background: #222; padding: 10px; box-sizing: border-box; }
        .wb-fullscreen #canvasContainer { height: 100% !important; background: white; min-height: 300px}
        
        /* ESTILOS VISOR MARKDOWN */
        #markdown-viewer-wrapper { background: #252525; color: #ccc; overflow: hidden; }
        .md-toolbar { background: #333; padding: 5px; display: flex; gap: 10px; border-bottom: 1px solid #444; align-items: center; }
        #md-content-area { flex: 1; padding: 20px; overflow-y: auto; background: #1e1e1e; font-family: 'Segoe UI', sans-serif; }
        
        /* Estilos Markdown dentro del visor */
        #md-content-area h1, #md-content-area h2 { color: var(--secondary); border-bottom: 1px solid #444; }
        #md-content-area table { width: 100%; border-collapse: collapse; margin: 10px 0; border:1px solid #444; }
        #md-content-area th { background: #333; padding: 5px; text-align: left; }
        #md-content-area td { border: 1px solid #444; padding: 5px; }

        /* TABS BIBLIOTECA */
        .tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 10px; }
        .tab-btn { flex: 1; background: transparent; border: none; border-bottom: 2px solid transparent; padding: 8px; color: #888; }
        .tab-btn.active { border-bottom-color: var(--secondary); color: var(--secondary); font-weight: bold; }
        .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }
        .search-box { width: 100%; padding: 8px; background: #111; border: 1px solid #444; color: white; box-sizing: border-box; margin-bottom: 10px; }
        .card-list { flex: 1; overflow-y: auto; }
        .tarjeta { background: #2a2a2a; padding: 10px; margin-bottom: 5px; border-radius: 4px; cursor: pointer; border: 1px solid #333; }

        /* RETRATO ACTIVO */
        #active-turn-container { text-align: center; margin-bottom: 15px; padding: 10px; background: #252525; border-radius: 8px; display: none; border: 1px solid var(--secondary); }
        #active-turn-img { max-width: 100%; max-height: 200px; border-radius: 4px; object-fit: contain; }
        #active-turn-name { display: block; margin-top: 5px; color: var(--secondary); font-weight: bold; font-size: 1.1em; }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: #1e1e1e; margin: 5% auto; padding: 20px; border: 1px solid #444; width: 80%; max-width: 800px; max-height: 80vh; overflow-y: auto; border-radius: 8px; color: #ddd; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .markdown-body img { max-width: 100%; }
        .modal-footer { margin-top: 20px; padding-top: 10px; border-top: 1px solid #444; text-align: right; display: flex; justify-content: flex-end; gap: 10px; }
    </style>
</head>
<body>

<header>
    <h1>üê≤ DM Control Center</h1>
    <div class="status-bar">
        <span>Turno: <strong id="currentTurnName">N/A</strong></span>
        <span>Ronda: <strong id="roundNumber">1</strong></span>
        <span class="status-indicator"></span>
        <span id="statusText">Listo</span>
    </div>
</header>

<div class="main-container">
    
    <div class="panel">
        <h2>Iniciativa</h2>
        <div class="controls-row">
            <input type="text" id="charName" placeholder="Nombre" style="flex:2; padding:5px; background:#111; border:1px solid #444; color:white;">
            <input type="number" id="charInitiative" placeholder="Ini" style="width:40px; padding:5px; background:#111; border:1px solid #444; color:white;">
            <input type="number" id="charHP" placeholder="PV" style="width:40px; padding:5px; background:#111; border:1px solid #444; color:white;">
            <button class="primary" id="addCharacterBtn">+</button>
        </div>
        <div id="initiativeList" class="initiative-list"></div>
        <div class="controls-row" style="margin-top:auto; padding-top:10px; border-top:1px solid #444;">
            <button onclick="prevTurn()">‚è™</button>
            <button onclick="nextTurn()" class="primary" style="flex:1">Siguiente ‚ñ∂</button>
            <button onclick="showInitiativeOnScreen()">üì∫ Ver</button>
        </div>
        <div class="controls-row">
            <button onclick="clearInitiative()" class="danger" style="flex:1">Reset</button>
        </div>
    </div>

    <div class="panel">
        <h2>Escenario & Multimedia</h2>
        
        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <button onclick="document.getElementById('selectImageBtn').click()" style="flex:1">üñºÔ∏è Img</button>
            <button onclick="document.getElementById('selectVideoBtn').click()" style="flex:1">üé¨ Vid</button>
            <button id="selectImageBtn" style="display:none;"></button>
            <button id="selectVideoBtn" style="display:none;"></button>
            <button onclick="showImage()">üì∫ Enviar</button>
            <button onclick="playVideo()">‚ñ∂ Play</button>
        </div>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input type="text" id="youtubeUrl" placeholder="URL YouTube" style="flex:1; background:#111; border:1px solid #444; color:white; padding:4px;">
            <button onclick="playYouTube()">‚ñ∂ YT</button>
            <button onclick="toggleYoutubePlayback()">‚èØ</button>
            <button id="blackoutBtn" style="background:black;">üåë</button>
            <button onclick="clearScreen()" style="background:#444;">üßπ</button>
        </div>

        <div class="center-tabs">
            <button class="center-tab-btn active" onclick="toggleCenterView('whiteboard')">üé® Pizarra</button>
            <button class="center-tab-btn" onclick="toggleCenterView('markdown')">üìù Visor MD</button>
        </div>
        <div class="panel">
            <h3>üéµ Audio Ambiente</h3>
                <div class="audio-controls">
                    <select id="audioList" class="form-control">
                        <option value="">Cargando...</option>
                    </select>
                    
                    <div style="margin-top: 10px; display: flex; gap: 5px; justify-content: center;">
                        <button onclick="playMasterAudio()" class="btn">‚ñ∂</button>
                        <button onclick="pauseMasterAudio()" class="btn">‚è∏</button>
                        <button onclick="stopMasterAudio()" class="btn">‚èπ</button>
                        <button onclick="openAudioPicker()" class="btn" title="Subir nuevo audio">üìÅ+</button>
                    </div>
                    
                    <input type="range" id="masterVolume" min="0" max="1" step="0.05" value="0.5" 
                        oninput="updateMasterVolume(this.value)" style="width:100%; margin-top:10px;">
            </div>
            <audio id="master-audio-element"></audio>
        </div>
        <div id="whiteboard-wrapper" class="visible">
            <div class="wb-toolbar">
                <button onclick="setTool('brush')" id="toolBrush" class="tool-btn active">‚úèÔ∏è</button>
                <button onclick="setTool('eraser')" id="toolEraser" class="tool-btn">üßΩ</button>
                <button onclick="setTool('line')" id="toolLine" class="tool-btn">üìè</button>
                <button onclick="setTool('rect')" id="toolRect" class="tool-btn">‚¨ú</button>
                <button onclick="setTool('circle')" id="toolCircle" class="tool-btn">‚≠ï</button>
                <input type="color" id="drawingColor" value="#000000">
                <input type="range" id="drawingLineWidth" min="1" max="20" value="3" style="width:50px;">
                <div style="flex:1"></div>
                <button onclick="clearCanvas()" class="danger">‚ùå</button>
                <button onclick="projectWhiteboard()">üì°</button>
                <div class="grid-controls">
                <button onclick="toggleGrid()" class="btn-tool">
                    <i class="fas fa-th"></i> Ver Rejilla
                    </button>
                </div>
            </div>
            <div id="canvasContainer">
                <canvas id="masterCanvas"></canvas>
            </div>
            <div style="background:#eee; padding:5px; border-top:1px solid #ccc;">
                <button id="btnFullscreenWB" onclick="toggleWhiteboardFullscreen()" style="width:100%; background:#333; color:white;">‚õ∂ Pantalla Completa</button>
            </div>
        </div>

        <div id="markdown-viewer-wrapper">
            <div class="md-toolbar">
                <input type="file" id="mdFileInput" accept=".md,.txt" style="display:none;" onchange="loadLocalMarkdown(this)">
                <button onclick="document.getElementById('mdFileInput').click()" style="background:#444; color:white;">üìÇ Abrir Archivo...</button>
                <span id="mdFileName" style="font-size:0.9em; color:#888;">Ning√∫n archivo</span>
                <div style="flex:1"></div>
                <button onclick="projectCustomMarkdown()" style="background-color: #673AB7; color:white;">üì° Proyectar</button>
            </div>
            <div id="md-content-area">
                <p style="text-align:center; color:#666; margin-top:50px;">
                    Selecciona un archivo Markdown (.md) de tu ordenador para visualizarlo aqu√≠.
                </p>
            </div>
        </div>
    </div>

    <div class="panel">
        <div id="active-turn-container">
            <img id="active-turn-img" src="" alt="Turno actual">
            <span id="active-turn-name"></span>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('tabMonsters')">Grimorio</button>
            <button class="tab-btn" onclick="openTab('tabSpells')">Conjuros</button>
            <button class="tab-btn" onclick="openTab('tabRules')">Reglas</button>
        </div>

        <div id="tabMonsters" class="tab-content active">
            <input type="text" id="grimoireFilter" class="search-box" placeholder="Buscar..." onkeyup="filterContent('monster')">
            <div class="card-list" id="grimoireList">
                {% for monster in grimorio_monsters %}
                <div class="tarjeta" onclick="showContentDetail('monster', '{{ monster.slug }}')" data-nombre="{{ monster.nombre }}">
                    <strong>{{ monster.nombre }}</strong>
                    <small>CR: {{ monster.cr }} | {{ monster.tipo }}</small>
                </div>
                {% endfor %}
            </div>
        </div>

        <div id="tabSpells" class="tab-content">
            <input type="text" id="spellFilter" class="search-box" placeholder="Buscar..." onkeyup="filterContent('spell')">
            <div class="card-list" id="spellList">
                {% for spell in grimorio_spells %}
                <div class="tarjeta" onclick="showContentDetail('spell', '{{ spell.slug }}')" data-nombre="{{ spell.nombre }}">
                    <strong>{{ spell.nombre }}</strong> <small>Nivel: {{ spell.level }}</small>
                </div>
                {% endfor %}
            </div>
        </div>

        <div id="tabRules" class="tab-content">
            <input type="text" id="ruleFilter" class="search-box" placeholder="Buscar..." onkeyup="filterContent('rule')">
            <div class="card-list" id="ruleList">
                {% for rule in grimorio_rules %}
                <div class="tarjeta" onclick="showContentDetail('rule', '{{ rule.slug }}')" data-nombre="{{ rule.nombre }}">
                    <strong>{{ rule.nombre }}</strong> <small>{{ rule.category }}</small>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div id="monsterModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="monsterDetailContent" class="markdown-body"></div>
        <div class="modal-footer">
            <div style="flex:1"></div>
            <input type="number" id="modalMonsterIni" placeholder="Ini" value="10" style="width:50px; padding:5px; background:#333; color:white; border:1px solid #555;">
            <button id="btnAddToInitiative" onclick="addMonsterToInitiative()" class="primary">‚öîÔ∏è A√±adir</button>
            <button onclick="projectCurrentCard()" style="background-color: #673AB7; color:white;">üì° Proyectar</button>
        </div>
    </div>
</div>

<script id="grimorio-data" type="application/json">{{ grimorio_monsters | tojson }}</script>
<script id="spells-data" type="application/json">{{ grimorio_spells | tojson }}</script>
<script id="rules-data" type="application/json">{{ grimorio_rules | tojson }}</script>

<script>
    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }
</script>
<script src="{{ url_for('static', filename='js/master.js') }}"></script>
</body>
</html>