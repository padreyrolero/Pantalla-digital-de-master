{% extends "layout/base.html" %}

{% block title %}DM Control Center{% endblock %}

{% block head_extra %}
  <!--
    Fabric.js canvas library (CDN)
    - Enables the whiteboard features (drawing, shapes, object manipulation).
  -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

  <!-- Page-specific stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/master.css') }}">
{% endblock %}

{% block content %}
<!--
  Page header:
  - Shows the app title and a status bar with:
    - current turn name
    - round number
    - connection/status indicator + status text (e.g., websocket state)
-->
<header>
  <h1>ğŸ² DM Control Center</h1>
  <div class="status-bar">
    <span>Turno: <strong id="currentTurnName">N/A</strong></span>
    <span>Ronda: <strong id="roundNumber">1</strong></span>
    <span class="status-indicator"></span>
    <span id="statusText">Listo</span>
  </div>
</header>

<div class="main-container">

  <!--
    LEFT PANEL: INITIATIVE
    Role:
    - Add characters to initiative order (name, initiative, HP).
    - Display and manage initiative list.
    - Navigate turns and optionally "project" the initiative to player display.
    - Reset session state.
   -->
  <div class="panel">
    <h2>Iniciativa</h2>

    <div class="controls-row">
      <input type="text" id="charName" placeholder="Nombre" class="input-flex">
      <input type="number" id="charInitiative" placeholder="Ini" class="input-small">
      <input type="number" id="charHP" placeholder="PV" class="input-small">
      <button class="primary" id="addCharacterBtn" data-action="add-character">+</button>
    </div>

    <!-- Initiative list rendered/updated by JS -->
    <div id="initiativeList" class="initiative-list"></div>

    <div class="controls-row footer-row">
      <button data-action="prev-turn">âª</button>
      <button data-action="next-turn" class="primary" style="flex:1">Siguiente â–¶</button>
      <button data-action="show-initiative">ğŸ“º Ver</button>
    </div>

    <div class="controls-row">
      <button data-action="reset-game" class="danger" style="flex:1">Reset</button>
    </div>
  </div>

  <!--
    CENTER PANEL: SCENARIO + MULTIMEDIA + WHITEBOARD/MARKDOWN
    Role:
    - Select and project images/videos/YouTube to player screen.
    - Provide screen management tools: toggle YouTube, blackout, clear screen.
    - Switch between two center "tabs": whiteboard and markdown viewer.
    - Provide ambient audio controls (play/pause/stop/upload, master volume).
  -->
  <div class="panel">
    <h2>Escenario & Multimedia</h2>

    <!-- Media selection/projection controls -->
    <div class="row-tight">
      <button data-action="pick-image" style="flex:1">ğŸ–¼ï¸ Img</button>
      <button data-action="pick-video" style="flex:1">ğŸ¬ Vid</button>

      <!--
        Hidden legacy buttons kept for compatibility:
        - Some existing JS may still expect these IDs.
        - Not intended to be clicked directly by the user.
      -->
      <button id="selectImageBtn" style="display:none;"></button>
      <button id="selectVideoBtn" style="display:none;"></button>

      <button data-action="send-image">ğŸ“º Enviar</button>
      <button data-action="send-video">â–¶ Play</button>
    </div>

    <!-- YouTube + screen control row -->
    <div class="row-tight">
      <input type="text" id="youtubeUrl" placeholder="URL YouTube" class="input-yt">
      <button data-action="send-youtube">â–¶ YT</button>
      <button data-action="toggle-youtube">â¯</button>
      <button id="blackoutBtn" data-action="blackout" style="background:black;">ğŸŒ‘</button>
      <button data-action="clear-screen" style="background:#444;">ğŸ§¹</button>
    </div>

    <!-- Center panel mode tabs: switch between whiteboard and markdown viewer -->
    <div class="center-tabs">
      <button class="center-tab-btn active" data-center-tab="whiteboard">ğŸ¨ Pizarra</button>
      <button class="center-tab-btn" data-center-tab="markdown">ğŸ“ Visor MD</button>
    </div>

    <!--
      AUDIO SECTION
      Role:
      - Ambient audio playlist selection and playback controls.
      - Upload new audio asset via data-action="audio-upload".
      - Master volume via range input.
    -->
    <div class="panel audio-section">
      <h3>ğŸµ Audio Ambiente</h3>
      <div class="audio-controls">
        <select id="audioList" class="form-control">
          <option value="">Cargando...</option>
        </select>

        <div class="audio-buttons">
          <button class="btn" data-action="audio-play">â–¶</button>
          <button class="btn" data-action="audio-pause">â¸</button>
          <button class="btn" data-action="audio-stop">â¹</button>
          <button class="btn" data-action="audio-upload" title="Subir nuevo audio">ğŸ“+</button>
        </div>

        <input type="range" id="masterVolume" min="0" max="1" step="0.05" value="0.5" class="volume-range">
      </div>

      <!-- Actual audio element controlled by JS -->
      <audio id="master-audio-element"></audio>
    </div>

    <!--
      WHITEBOARD WRAPPER
      Role:
      - Fabric.js-powered drawing surface.
      - Tool selection: brush/eraser/line/rect/circle.
      - Config: color picker, line width.
      - Actions: clear, project, toggle grid, fullscreen.
    -->
    <div id="whiteboard-wrapper" class="visible">
      <div class="wb-toolbar">
        <button id="toolBrush" class="tool-btn active" data-tool="brush">âœï¸</button>
        <button id="toolEraser" class="tool-btn" data-tool="eraser">ğŸ§½</button>
        <button id="toolLine" class="tool-btn" data-tool="line">ğŸ“</button>
        <button id="toolRect" class="tool-btn" data-tool="rect">â¬œ</button>
        <button id="toolCircle" class="tool-btn" data-tool="circle">â­•</button>

        <input type="color" id="drawingColor" value="#000000">
        <input type="range" id="drawingLineWidth" min="1" max="20" value="3" style="width:50px;">

        <!-- Spacer to push actions to the right -->
        <div style="flex:1"></div>

        <button class="danger" data-action="wb-clear">âŒ</button>
        <button data-action="wb-project">ğŸ“¡</button>

        <!-- Grid toggle group (icon implies Font Awesome usage in CSS/JS elsewhere) -->
        <div class="grid-controls">
          <button class="btn-tool" data-action="wb-toggle-grid">
            <i class="fas fa-th"></i> Ver Rejilla
          </button>
        </div>
      </div>

      <!-- Canvas container: typically used for responsive resizing/scaling -->
      <div id="canvasContainer">
        <canvas id="masterCanvas"></canvas>
      </div>

      <div class="wb-footer">
        <button id="btnFullscreenWB" class="wb-fullscreen-btn" data-action="wb-fullscreen">
          â›¶ Pantalla Completa
        </button>
      </div>
    </div>

    <!--
      MARKDOWN VIEWER WRAPPER
      Role:
      - Lets the DM open a local Markdown/Text file and render it in the UI.
      - Supports projection via data-action="md-project".
    -->
    <div id="markdown-viewer-wrapper">
      <div class="md-toolbar">
        <input type="file" id="mdFileInput" accept=".md,.txt" style="display:none;">
        <button class="btn-md-open" data-action="md-open">ğŸ“‚ Abrir Archivo...</button>
        <span id="mdFileName" class="md-filename">NingÃºn archivo</span>
        <div style="flex:1"></div>
        <button class="btn-md-project" data-action="md-project">ğŸ“¡ Proyectar</button>
      </div>

      <div id="md-content-area">
        <p class="md-empty">
          Selecciona un archivo Markdown (.md) de tu ordenador para visualizarlo aquÃ­.
        </p>
      </div>
    </div>
  </div>

  <!--
    RIGHT PANEL: GRIMOIRE / SPELLS / RULES
    Role:
    - Shows active turn portrait/name (mirrors initiative active entity).
    - Provides tabbed browsing for monsters, spells, and rules.
    - Each tab supports:
      - Search filter input
      - Card list rendered server-side (loop over dataset)
    - Cards include data attributes used by JS to:
      - Identify content type (data-ctype)
      - Identify item slug (data-slug)
      - Provide display name (data-nombre)
      - Open modal detail view and allow projection / add-to-initiative.
  -->
  <div class="panel">
    <div id="active-turn-container">
      <img id="active-turn-img" src="" alt="Turno actual">
      <span id="active-turn-name"></span>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="tabMonsters">Grimorio</button>
      <button class="tab-btn" data-tab="tabSpells">Conjuros</button>
      <button class="tab-btn" data-tab="tabRules">Reglas</button>
    </div>

    <!-- Monsters tab -->
    <div id="tabMonsters" class="tab-content active">
      <input type="text" id="grimoireFilter" class="search-box" placeholder="Buscar..." data-filter="monster">
      <div class="card-list" id="grimoireList">
        {% for monster in grimorio_monsters %}
        <!--
          Grimoire card:
          - data-ctype: content type for routing logic in JS
          - data-slug: unique identifier for fetching/rendering details
          - data-nombre: display name for quick access in JS
        -->
        <div class="tarjeta" data-ctype="monster" data-slug="{{ monster.slug }}" data-nombre="{{ monster.nombre }}">
          <strong>{{ monster.nombre }}</strong>
          <small>CR: {{ monster.cr }} | {{ monster.tipo }}</small>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Spells tab -->
    <div id="tabSpells" class="tab-content">
      <input type="text" id="spellFilter" class="search-box" placeholder="Buscar..." data-filter="spell">
      <div class="card-list" id="spellList">
        {% for spell in grimorio_spells %}
        <div class="tarjeta" data-ctype="spell" data-slug="{{ spell.slug }}" data-nombre="{{ spell.nombre }}">
          <strong>{{ spell.nombre }}</strong> <small>Nivel: {{ spell.level }}</small>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Rules tab -->
    <div id="tabRules" class="tab-content">
      <input type="text" id="ruleFilter" class="search-box" placeholder="Buscar..." data-filter="rule">
      <div class="card-list" id="ruleList">
        {% for rule in grimorio_rules %}
        <div class="tarjeta" data-ctype="rule" data-slug="{{ rule.slug }}" data-nombre="{{ rule.nombre }}">
          <strong>{{ rule.nombre }}</strong> <small>{{ rule.category }}</small>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!--
  MODAL: Content detail viewer (primarily for monsters, but can be extended)
  Role:
  - Displays detailed rendered content in #monsterDetailContent (likely HTML from markdown).
  - Offers footer controls:
    - close modal
    - set initiative value (modalMonsterIni)
    - add selected entity to initiative (btnAddToInitiative)
    - project the card/detail to player screen
-->
<div id="monsterModal" class="modal">
  <div class="modal-content">
    <span class="close" data-action="modal-close">&times;</span>
    <div id="monsterDetailContent" class="markdown-body"></div>
    <div class="modal-footer">
      <div style="flex:1"></div>
      <input type="number" id="modalMonsterIni" placeholder="Ini" value="10" class="modal-ini">
      <button id="btnAddToInitiative" class="primary" data-action="modal-add-to-initiative">âš”ï¸ AÃ±adir</button>
      <button class="btn-project" data-action="modal-project-card">ğŸ“¡ Proyectar</button>
    </div>
  </div>
</div>

<!--
  Embedded JSON datasets for master.js
  Role:
  - Provide the full grimoire/spells/rules objects client-side without extra requests.
  - Each script tag uses type="application/json" so it is not executed as JS.
  - master.js can parse with JSON.parse(document.getElementById(...).textContent)

  IDs:
  - grimorio-data, spells-data, rules-data
-->
<script id="grimorio-data" type="application/json">{{ grimorio_monsters | tojson }}</script>
<script id="spells-data" type="application/json">{{ grimorio_spells | tojson }}</script>
<script id="rules-data" type="application/json">{{ grimorio_rules | tojson }}</script>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='js/master.js') }}"></script>
{% endblock %}